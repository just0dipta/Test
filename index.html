<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Puzzle Quest</title>
<style>
  * { 
    box-sizing: border-box; 
    margin: 0; 
    padding: 0; 
  }
  
  html, body {
    height: 100%; 
    overflow: hidden;
    background: #121217;
    color: #eee;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    touch-action: manipulation;
  }
  
  body {
    display: flex; 
    align-items: center; 
    justify-content: center;
    -webkit-tap-highlight-color: transparent;
  }
  
  #game-container {
    background: #1e1e2f;
    border-radius: 16px;
    box-shadow: 0 0 15px 2px #440099aa, 0 10px 25px rgba(0,0,0,0.9);
    width: 100%;
    max-width: 340px;
    height: 100%;
    max-height: 600px;
    display: flex;
    flex-direction: column;
    padding: 16px;
    box-sizing: border-box;
    position: relative;
    transition: all 0.3s ease;
  }
  
  body.fullscreen #game-container {
    max-width: 100%;
    max-height: 100%;
    border-radius: 0;
  }
  
  #top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #2a2a44;
  }
  
  #profile-section {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  #player-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #bb86fc;
    cursor: pointer;
  }
  
  #profile-name {
    font-weight: 700;
    color: #bb86fccc;
    font-size: 0.9rem;
    user-select: none;
    cursor: pointer;
  }
  
  #options-section {
    display: flex;
    gap: 10px;
  }
  
  .option-btn {
    background: #3b3d5c;
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    color: white;
    font-size: 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  
  .option-btn:hover {
    background: #4b4d6c;
  }
  
  .badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4c4c;
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  #player-menu {
    position: absolute;
    top: 70px;
    right: 20px;
    background: #2a2a44;
    border-radius: 8px;
    padding: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    z-index: 1000;
    display: none;
    flex-direction: column;
    gap: 8px;
    width: 180px;
  }
  
  #player-menu button {
    background: #3b3d5c;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    color: white;
    text-align: left;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  #player-menu button:hover {
    background: #4b4d6c;
  }
  
  header { 
    text-align: center; 
    margin-bottom: 8px; 
    user-select: none; 
  }
  
  header h1 {
    font-size: 1.8rem;
    letter-spacing: 2.5px;
    margin: 0 0 2px;
    color: #bb86fc;
    text-shadow: 0 0 8px #bb86fc99;
  }
  
  header p {
    margin: 0;
    font-size: 0.85rem;
    color: #aaaabbcc;
  }
  
  #score-board {
    margin: 4px 0 8px;
    font-weight: 700;
    font-size: 1.1rem;
    text-align: center;
    color: #ffb86c;
    text-shadow: 0 0 4px #ffb86c99;
    user-select: none;
    line-height: 1.4;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  .score-badge {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
  }
  
  .bronze {
    background: linear-gradient(135deg, #cd7f32, #a67c52);
    box-shadow: 0 0 8px #cd7f32aa;
  }
  
  .silver {
    background: linear-gradient(135deg, #c0c0c0, #a0a0a0);
    box-shadow: 0 0 8px #c0c0c0aa;
  }
  
  .gold {
    background: linear-gradient(135deg, #ffd700, #d4af37);
    box-shadow: 0 0 8px #ffd700aa;
  }
  
  .platinum {
    background: linear-gradient(135deg, #e5e4e2, #b8b8b8);
    box-shadow: 0 0 8px #e5e4e2aa;
  }
  
  .diamond {
    background: linear-gradient(135deg, #b9f2ff, #7ec8e3);
    box-shadow: 0 0 8px #b9f2ffaa;
  }
  
  #board {
    flex-grow: 1;
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    grid-gap: 4px;
    background: #2a2a44;
    border-radius: 14px;
    padding: 6px;
    box-shadow: inset 0 0 12px #111133cc;
    user-select: none;
    position: relative;
  }
  
  .tile {
    background: #3b3d5c;
    border-radius: 10px;
    width: 100%;
    aspect-ratio: 1/1;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.7rem;
    user-select: none;
    border: 3px solid transparent;
    transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.3s ease;
    box-shadow: inset 0 1px 3px #666777aa;
    position: relative;
    overflow: hidden;
  }
  
  .tile.selected {
    outline: 3px solid #fff;
    box-shadow: 0 0 16px 4px #ffffffcc;
    transform: scale(1.1);
    z-index: 10;
  }
  
  .tile.color-0 { border-color: #ff4c4c; }
  .tile.color-1 { border-color: #f7a932; }
  .tile.color-2 { border-color: #3bb3ff; }
  .tile.color-3 { border-color: #40da47; }
  .tile.color-4 { border-color: #ffd947; }
  .tile.color-5 { border-color: #ac41ff; }
  
  .tile.matched {
    animation: matchAnimation 0.5s ease-out forwards;
  }
  
  @keyframes matchAnimation {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.3); opacity: 0.7; }
    100% { transform: scale(0); opacity: 0; }
  }
  
  .explosion {
    position: absolute;
    width: 100%;
    height: 100%;
    pointer-events: none;
    background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
    opacity: 0;
    animation: explode 0.5s ease-out forwards;
  }
  
  @keyframes explode {
    0% { transform: scale(0); opacity: 0.8; }
    100% { transform: scale(3); opacity: 0; }
  }
  
  #controls {
    margin-top: 8px;
    display: flex;
    justify-content: space-between;
  }
  
  button {
    background: #bb86fc;
    color: #121217;
    border: none;
    border-radius: 14px;
    padding: 10px 18px;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 6px 14px #bb86fcaa;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    user-select: none;
  }
  
  button:hover,
  button:focus {
    background: #9a6fff;
    box-shadow: 0 8px 18px #9a6fffcc;
    outline: none;
  }
  
  #instructions {
    font-size: 0.75rem;
    color: #999aadcc;
    margin-top: 6px;
    text-align: center;
    user-select: none;
    line-height: 1.3;
  }
  
  /* Leaderboard Modal */
  #leaderboard-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    width: 320px;
    height: 80vh;
    background: #1e1e2f;
    border-radius: 16px;
    box-shadow: 0 0 20px #bb86fccc;
    color: #eee;
    z-index: 2000;
    transition: transform 0.3s ease;
    user-select: none;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  #leaderboard-modal.show {
    transform: translate(-50%, -50%) scale(1);
  }
  
  #leaderboard-header {
    background: #3b3d5c;
    padding: 14px;
    font-weight: 700;
    font-size: 1.3rem;
    text-align: center;
    border-top-left-radius: 16px;
    border-top-right-radius: 16px;
    user-select: none;
  }
  
  #leaderboard-content {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  #leaderboard-tabs {
    display: flex;
    background: #2a2a44;
  }
  
  .leaderboard-tab {
    flex: 1;
    padding: 10px;
    text-align: center;
    cursor: pointer;
    border-bottom: 2px solid transparent;
  }
  
  .leaderboard-tab.active {
    border-bottom: 2px solid #bb86fc;
    color: #bb86fc;
  }
  
  #leaderboard-list {
    flex-grow: 1;
    overflow-y: auto;
    padding: 8px 16px;
  }
  
  #leaderboard-list ul {
    list-style: none;
    margin: 0;
    padding: 0;
  }
  
  #leaderboard-list li {
    padding: 12px 8px;
    border-bottom: 1px solid #555577;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 600;
  }
  
  #leaderboard-list li:last-child {
    border-bottom: none;
  }
  
  .leaderboard-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #bb86fc;
  }
  
  .leaderboard-name {
    flex-grow: 1;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .leaderboard-score {
    color: #ffb86c;
    min-width: 60px;
    text-align: right;
  }
  
  .leaderboard-badge {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.6rem;
    font-weight: bold;
  }
  
  #leaderboard-footer {
    background: #3b3d5c;
    padding: 10px 14px;
    display: flex;
    justify-content: flex-end;
    border-bottom-left-radius: 16px;
    border-bottom-right-radius: 16px;
  }
  
  /* Chat Modal */
  #chat-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    width: 320px;
    height: 80vh;
    background: #1e1e2f;
    border-radius: 16px;
    box-shadow: 0 0 20px #bb86fccc;
    color: #eee;
    z-index: 2000;
    transition: transform 0.3s ease;
    user-select: none;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  #chat-modal.show {
    transform: translate(-50%, -50%) scale(1);
  }
  
  #chat-header {
    background: #3b3d5c;
    padding: 14px;
    font-weight: 700;
    font-size: 1.3rem;
    text-align: center;
    border-top-left-radius: 16px;
    border-top-right-radius: 16px;
    user-select: none;
  }
  
  #chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .chat-message {
    background: #2a2a44;
    border-radius: 12px;
    padding: 8px 12px;
    max-width: 80%;
  }
  
  .chat-message.own {
    align-self: flex-end;
    background: #bb86fc;
    color: #121217;
  }
  
  .chat-message.other {
    align-self: flex-start;
  }
  
  .message-sender {
    font-weight: bold;
    font-size: 0.8rem;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .message-avatar {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    object-fit: cover;
  }
  
  .message-text {
    word-wrap: break-word;
  }
  
  .message-time {
    font-size: 0.7rem;
    opacity: 0.7;
    text-align: right;
    margin-top: 4px;
  }
  
  #chat-input-container {
    display: flex;
    padding: 10px;
    background: #2a2a44;
    gap: 8px;
  }
  
  #chat-input {
    flex-grow: 1;
    padding: 10px;
    border-radius: 20px;
    border: none;
    background: #3b3d5c;
    color: white;
  }
  
  #chat-send {
    background: #bb86fc;
    color: #121217;
    border: none;
    border-radius: 20px;
    padding: 0 15px;
    font-weight: bold;
    cursor: pointer;
  }
  
  /* Other modals */
  #rename-modal, #avatar-modal, #team-modal, #friends-modal, #private-chat-modal, #shop-modal, #theme-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 3000;
    display: none;
  }
  
  .modal-content {
    background: #1e1e2f;
    padding: 24px;
    border-radius: 16px;
    width: 300px;
    text-align: center;
  }
  
  .modal-content h2 {
    margin-top: 0;
    color: #bb86fc;
  }
  
  .modal-content input {
    width: 100%;
    padding: 12px;
    margin: 16px 0;
    border: 2px solid #bb86fc;
    border-radius: 8px;
    background: #2a2a44;
    color: white;
    font-size: 1rem;
  }
  
  .modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
  }
  
  .modal-buttons button {
    flex: 1;
  }
  
  #avatar-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 15px;
  }
  
  #camera-preview {
    width: 100%;
    max-height: 200px;
    object-fit: contain;
    background: #2a2a44;
    border-radius: 8px;
    display: none;
  }
  
  #avatar-image-preview {
    width: 100%;
    max-height: 200px;
    object-fit: contain;
    border-radius: 8px;
    display: none;
  }
  
  /* Team Modal */
  .team-member {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 10px 0;
    padding: 10px;
    background: #2a2a44;
    border-radius: 8px;
  }
  
  .team-member-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #bb86fc;
  }
  
  .team-member-info {
    flex-grow: 1;
    text-align: left;
  }
  
  .team-member-name {
    font-weight: bold;
  }
  
  .team-member-role {
    font-size: 0.8rem;
    color: #aaa;
  }
  
  /* Friends Modal */
  .friend-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 10px 0;
    padding: 10px;
    background: #2a2a44;
    border-radius: 8px;
    cursor: pointer;
  }
  
  .friend-item:hover {
    background: #3b3d5c;
  }
  
  .friend-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #bb86fc;
  }
  
  .friend-name {
    flex-grow: 1;
    font-weight: bold;
  }
  
  .friend-status {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #aaa;
  }
  
  .friend-status.online {
    background: #40da47;
  }
  
  /* Private Chat Modal */
  #private-chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 300px;
  }
  
  /* Shop Modal */
  .shop-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 10px 0;
    padding: 10px;
    background: #2a2a44;
    border-radius: 8px;
  }
  
  .shop-item-image {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    object-fit: cover;
    border: 2px solid #bb86fc;
  }
  
  .shop-item-info {
    flex-grow: 1;
    text-align: left;
  }
  
  .shop-item-name {
    font-weight: bold;
  }
  
  .shop-item-price {
    font-size: 0.9rem;
    color: #ffb86c;
  }
  
  .shop-item-button {
    background: #bb86fc;
    color: #121217;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-weight: bold;
    cursor: pointer;
  }
  
  .shop-item-button:disabled {
    background: #555577;
    cursor: not-allowed;
  }
  
  /* Theme Modal */
  .theme-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 10px 0;
    padding: 10px;
    background: #2a2a44;
    border-radius: 8px;
    cursor: pointer;
  }
  
  .theme-item:hover {
    background: #3b3d5c;
  }
  
  .theme-item.active {
    border: 2px solid #bb86fc;
  }
  
  .theme-preview {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    object-fit: cover;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    background: #3b3d5c;
  }
  
  .theme-name {
    flex-grow: 1;
    font-weight: bold;
  }
  
  @media (max-width: 400px) {
    #game-container {
      padding: 12px;
    }
    
    header h1 {
      font-size: 1.6rem;
    }
    
    #score-board {
      font-size: 1rem;
    }
    
    button {
      font-size: 0.9rem;
      padding: 8px 16px;
    }
    
    #instructions {
      font-size: 0.7rem;
    }
    
    #leaderboard-modal, #chat-modal {
      width: 90vw;
    }
    
    .modal-content {
      width: 90vw;
    }
  }
  
  #add-friend-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 3000;
    display: none;
  }

  .modal-content {
    background: #1e1e2f;
    padding: 24px;
    border-radius: 16px;
    width: 300px;
    text-align: center;
    position: relative;
    animation: modalFadeIn 0.3s ease-out;
  }

  @keyframes modalFadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
<!-- Firebase scripts -->
<script src="https://www.gstatic.com/firebasejs/9.18.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.18.0/firebase-database-compat.js"></script>
</head>
<body>
<div id="name-modal">
  <div id="name-form" class="modal-content">
    <h2>Enter Your Name</h2>
    <input type="text" id="name-input" placeholder="Player name" maxlength="20" autofocus>
    <button id="name-submit">Start Game</button>
  </div>
</div>

<div id="game-container" aria-label="Puzzle Quest game" style="display: none;">
  <div id="top-bar">
    <div id="profile-section">
      <img id="player-avatar" src="https://ui-avatars.com/api/?name=Player&background=bb86fc&color=121217">
      <div id="profile-name">Player</div>
    </div>
    
    <div id="options-section">
      <button id="menu-btn" class="option-btn">‚ò∞</button>
      <button id="chat-btn" class="option-btn">üí¨
        <span id="chat-badge" class="badge" style="display: none;">0</span>
      </button>
      <button id="shop-btn" class="option-btn">üõí</button>
      <button id="friends-btn" class="option-btn">üë•
        <span id="friends-badge" class="badge" style="display: none;">0</span>
      </button>
    </div>
    
    <div id="player-menu">
      <button id="rename-btn"><span>‚úèÔ∏è</span> Rename</button>
      <button id="camera-btn"><span>üì∑</span> Take Photo</button>
      <button id="gallery-btn"><span>üñºÔ∏è</span> Choose from Gallery</button>
      <button id="theme-btn"><span>üé®</span> Change Theme</button>
      <button id="team-btn"><span>üë™</span>Game Creator</button>
      <button id="reset-score-btn"><span>üîÑ</span> Reset Score</button>
      <button id="fullscreen-btn"><span>‚õ∂</span> Fullscreen</button>
    </div>
  </div>
  
  <header>
    <h1>Puzzle Quest</h1>
    <p>Match 3 or more tiles by swapping adjacent ones!</p>
  </header>
  
  <div id="score-board">Score: 0 <span id="score-badge" class="score-badge bronze">B</span></div>
  <div id="board" aria-label="Game board, 6 by 6 grid" tabindex="0"></div>
  
  <div id="controls">
    <button id="reset-btn" aria-label="Reset game">Reset Game</button>
    <button id="leaderboard-btn" aria-label="Show Leaderboard">Leaderboard</button>
  </div>
  
  <div id="instructions">
    Tap or click a tile to select it, then tap an adjacent tile to swap.<br />
    Match 3 or more tiles of the same fruit horizontally or vertically to score points.
  </div>
</div>

<!-- Leaderboard Modal -->
<div id="leaderboard-modal" role="dialog" aria-modal="true" aria-labelledby="leaderboard-header" tabindex="-1" aria-hidden="true">
  <div id="leaderboard-header">Leaderboard</div>
  <div id="leaderboard-content">
    <div id="leaderboard-tabs">
      <div class="leaderboard-tab active" data-tab="global">Global</div>
      <div class="leaderboard-tab" data-tab="friends">Friends</div>
    </div>
    <div id="leaderboard-list">
      <ul id="leaderboard-scores"></ul>
    </div>
  </div>
  <div id="leaderboard-footer">
    <button id="close-leaderboard">Close</button>
  </div>
</div>

<!-- Chat Modal -->
<div id="chat-modal" role="dialog" aria-modal="true" aria-labelledby="chat-header" tabindex="-1" aria-hidden="true">
  <div id="chat-header">Global Chat</div>
  <div id="chat-messages"></div>
  <div id="chat-input-container">
    <input type="text" id="chat-input" placeholder="Type your message..." maxlength="200">
    <button id="chat-send">Send</button>
  </div>
  <div id="chat-footer">
    <button id="close-chat">Close</button>
  </div>
</div>

<!-- Rename Modal -->
<div id="rename-modal">
  <div class="modal-content">
    <h2>Change Your Name</h2>
    <input type="text" id="rename-input" placeholder="New name" maxlength="20" autofocus>
    <div class="modal-buttons">
      <button id="rename-cancel">Cancel</button>
      <button id="rename-confirm">Save</button>
    </div>
  </div>
</div>

<!-- Avatar Modal -->
<div id="avatar-modal">
  <div class="modal-content">
    <h2 id="avatar-modal-title">Take Photo</h2>
    <video id="camera-preview" autoplay playsinline></video>
    <img id="avatar-image-preview" alt="Image preview">
    <div id="avatar-options">
      <button id="capture-btn">Capture</button>
      <button id="upload-btn">Upload</button>
      <button id="avatar-cancel">Cancel</button>
    </div>
  </div>
</div>

<!-- Theme Modal -->
<div id="theme-modal">
  <div class="modal-content">
    <h2>Select Theme</h2>
    <div id="theme-list">
      <div class="theme-item active" data-theme="default">
        <div class="theme-preview">üçé</div>
        <div class="theme-name">Default (Fruits)</div>
      </div>
      <div class="theme-item" data-theme="minecraft">
        <div class="theme-preview">‚õèÔ∏è</div>
        <div class="theme-name">Minecraft</div>
      </div>
      <div class="theme-item" data-theme="emoji">
        <div class="theme-preview">üòÄ</div>
        <div class="theme-name">Emoji</div>
      </div>
      <div class="theme-item" data-theme="special">
        <div class="theme-preview">‚ú®</div>
        <div class="theme-name">Special</div>
      </div>
    </div>
    <div class="modal-buttons">
      <button id="close-theme">Close</button>
    </div>
  </div>
</div>

<!-- Team Modal -->
<div id="team-modal">
  <div class="modal-content">
    <h2>DDAF TEAM</h2>
    <div id="team-members">
      <div class="team-member">
        <img src="images/dipta.jpg" class="team-member-avatar">
        <div class="team-member-info">
          <div class="team-member-name">Dipta</div>
          <div class="team-member-role">developer</div>
        </div>
      </div>
      <div class="team-member">
        <img src="images/dilfa.jpg" class="team-member-avatar">
        <div class="team-member-info">
          <div class="team-member-name">Dilfa</div>
          <div class="team-member-role">Data base</div>
        </div>
      </div>
      <div class="team-member">
        <img src="images/dafi.jpg" class="team-member-avatar">
        <div class="team-member-info">
          <div class="team-member-name">Dafi</div>
          <div class="team-member-role">Designer</div>
        </div>
      </div>
    </div>
    <div class="modal-buttons">
      <button id="close-team">Close</button>
    </div>
  </div>
</div>

<!-- Friends Modal -->
<div id="friends-modal">
  <div class="modal-content">
    <h2>Friends</h2>
    <div id="friends-list">
      <!-- Friends will be loaded here -->
    </div>
    <div class="modal-buttons">
      <button id="close-friends">Close</button>
      <button id="add-friend-btn">Add Friend</button>
    </div>
  </div>
</div>

<!-- Private Chat Modal -->
<div id="private-chat-modal">
  <div class="modal-content">
    <h2 id="private-chat-title">Private Chat</h2>
    <div id="private-chat-messages"></div>
    <div id="private-chat-input-container">
      <input type="text" id="private-chat-input" placeholder="Type your message..." maxlength="200">
      <button id="private-chat-send">Send</button>
    </div>
    <div class="modal-buttons">
      <button id="close-private-chat">Close</button>
    </div>
  </div>
</div>

<!-- Shop Modal -->
<div id="shop-modal">
  <div class="modal-content">
    <h2>Shop</h2>
    <div id="shop-items">
      <div class="shop-item" data-item="power_boost" data-price="100">
        <img src="images/boost.png" class="shop-item-image">
        <div class="shop-item-info">
          <div class="shop-item-name">Power Boost</div>
          <div class="shop-item-price">100 points</div>
        </div>
        <button class="shop-item-button">Buy</button>
      </div>
      <div class="shop-item" data-item="extra_moves" data-price="150">
        <img src="images/moves.png" class="shop-item-image">
        <div class="shop-item-info">
          <div class="shop-item-name">Extra Moves</div>
          <div class="shop-item-price">150 points</div>
        </div>
        <button class="shop-item-button">Buy</button>
      </div>
      <div class="shop-item" data-item="minecraft_theme" data-price="200">
        <img src="images/mc.png" class="shop-item-image">
        <div class="shop-item-info">
          <div class="shop-item-name">Minecraft Theme</div>
          <div class="shop-item-price">200 points</div>
        </div>
        <button class="shop-item-button">Buy</button>
      </div>
      <div class="shop-item" data-item="emoji_theme" data-price="200">
        <img src="images/emoji.png" class="shop-item-image">
        <div class="shop-item-info">
          <div class="shop-item-name">Emoji Theme</div>
          <div class="shop-item-price">200 points</div>
        </div>
        <button class="shop-item-button">Buy</button>
      </div>
      <div class="shop-item" data-item="special_theme" data-price="300">
        <img src="images/special.png" class="shop-item-image">
        <div class="shop-item-info">
          <div class="shop-item-name">Special Theme</div>
          <div class="shop-item-price">300 points</div>
        </div>
        <button class="shop-item-button">Buy</button>
      </div>
    </div>
    <div class="modal-buttons">
      <button id="close-shop">Close</button>
    </div>
  </div>
</div>

<!-- Add Friend Modal -->
<div id="add-friend-modal">
  <div class="modal-content">
    <h2>Add Friend</h2>
    <input type="text" id="friend-name-input" placeholder="Friend's name" maxlength="20" autofocus>
    <div class="modal-buttons">
      <button id="cancel-add-friend">Cancel</button>
      <button id="confirm-add-friend">Add</button>
    </div>
  </div>
</div>

<!-- Hidden file input -->
<input type="file" id="file-input" accept="image/*" style="display: none;">

<!-- Audio elements for sound effects -->
<audio id="swap-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3" preload="auto"></audio>
<audio id="match-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-unlock-game-notification-253.mp3" preload="auto"></audio>
<audio id="select-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-quick-jump-arcade-game-239.mp3" preload="auto"></audio>
<audio id="button-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-mechanical-bling-210.mp3" preload="auto"></audio>
<audio id="explosion-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3" preload="auto"></audio>

<script>
(() => {
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDexnxE8BAytVuwp8QlqTGdqp-T8TvT-JI",
    authDomain: "puzzlequestgame-2b885.firebaseapp.com",
    databaseURL: "https://puzzlequestgame-2b885-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "puzzlequestgame-2b885",
    storageBucket: "puzzlequestgame-2b885.firebasestorage.app",
    messagingSenderId: "853619803651",
    appId: "1:853619803651:web:1d5be33744a40562ad7036"
  };
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  // Game constants
  const ROWS = 6;
  const COLS = 6;
  const COLORS_COUNT = 6;
  
  // Theme definitions
  const themes = {
    default: {
      name: "Default (Fruits)",
      emojis: ['üçé', 'üçä', 'ü•≠', 'üçì', 'üçå', 'üçë'],
      colors: ['#ff4c4c', '#f7a932', '#3bb3ff', '#40da47', '#ffd947', '#ac41ff']
    },
    minecraft: {
      name: "Minecraft",
      emojis: ['‚õèÔ∏è', 'üå≥', 'üî•', 'üíé', 'üåæ', 'ü™ì'],
      colors: ['#8B8B8B', '#4C7631', '#E25822', '#5CD6F5', '#F5DE5D', '#A0522D']
    },
    emoji: {
      name: "Emoji",
      emojis: ['üòÄ', 'üòÇ', 'üòç', 'üòé', 'ü§î', 'ü•≥'],
      colors: ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#A162E8', '#FF9F43']
    },
    special: {
      name: "Special",
      emojis: ['‚ú®', 'üåü', 'üí´', '‚ö°', 'üåà', 'üéØ'],
      colors: ['#FF9FF3', '#FECA57', '#FF6B6B', '#48DBFB', '#1DD1A1', '#F368E0']
    }
  };

  // Game state
  let grid = [];
  let selectedTile = null;
  let score = 0;
  let playerName = 'Player';
  let lastGameState = null;
  let stream = null;
  let currentLeaderboardTab = 'global';
  let friends = [];
  let currentPrivateChatWith = null;
  let unreadChatMessages = 0;
  let unreadPrivateMessages = 0;
  let lastChatCheck = 0;
  let lastPrivateChatCheck = 0;
  let currentTheme = 'default';
  let purchasedThemes = ['default']; // Default theme is always available
  let powerBoostActive = false;
  let extraMoves = 0;

  // DOM elements
  const nameModal = document.getElementById('name-modal');
  const nameInput = document.getElementById('name-input');
  const nameSubmit = document.getElementById('name-submit');
  const gameContainer = document.getElementById('game-container');
  const profileName = document.getElementById('profile-name');
  const playerAvatar = document.getElementById('player-avatar');
  const playerMenu = document.getElementById('player-menu');
  const menuBtn = document.getElementById('menu-btn');
  const chatBtn = document.getElementById('chat-btn');
  const chatBadge = document.getElementById('chat-badge');
  const shopBtn = document.getElementById('shop-btn');
  const friendsBtn = document.getElementById('friends-btn');
  const friendsBadge = document.getElementById('friends-badge');
  const scoreBoard = document.getElementById('score-board');
  const scoreBadge = document.getElementById('score-badge');
  const board = document.getElementById('board');
  const resetBtn = document.getElementById('reset-btn');
  const leaderboardBtn = document.getElementById('leaderboard-btn');
  const leaderboardModal = document.getElementById('leaderboard-modal');
  const leaderboardContent = document.getElementById('leaderboard-content');
  const leaderboardScores = document.getElementById('leaderboard-scores');
  const closeLeaderboardBtn = document.getElementById('close-leaderboard');
  const chatModal = document.getElementById('chat-modal');
  const chatMessages = document.getElementById('chat-messages');
  const chatInput = document.getElementById('chat-input');
  const chatSend = document.getElementById('chat-send');
  const closeChatBtn = document.getElementById('close-chat');
  const renameModal = document.getElementById('rename-modal');
  const renameInput = document.getElementById('rename-input');
  const renameCancel = document.getElementById('rename-cancel');
  const renameConfirm = document.getElementById('rename-confirm');
  const avatarModal = document.getElementById('avatar-modal');
  const cameraPreview = document.getElementById('camera-preview');
  const avatarImagePreview = document.getElementById('avatar-image-preview');
  const captureBtn = document.getElementById('capture-btn');
  const uploadBtn = document.getElementById('upload-btn');
  const avatarCancel = document.getElementById('avatar-cancel');
  const cameraBtn = document.getElementById('camera-btn');
  const galleryBtn = document.getElementById('gallery-btn');
  const renameBtn = document.getElementById('rename-btn');
  const themeBtn = document.getElementById('theme-btn');
  const themeModal = document.getElementById('theme-modal');
  const themeList = document.getElementById('theme-list');
  const closeThemeBtn = document.getElementById('close-theme');
  const fileInput = document.getElementById('file-input');
  const avatarModalTitle = document.getElementById('avatar-modal-title');
  const leaderboardTabs = document.querySelectorAll('.leaderboard-tab');
  const teamModal = document.getElementById('team-modal');
  const teamMembers = document.getElementById('team-members');
  const closeTeamBtn = document.getElementById('close-team');
  const teamBtn = document.getElementById('team-btn');
  const friendsModal = document.getElementById('friends-modal');
  const friendsList = document.getElementById('friends-list');
  const closeFriendsBtn = document.getElementById('close-friends');
  const addFriendBtn = document.getElementById('add-friend-btn');
  const privateChatModal = document.getElementById('private-chat-modal');
  const privateChatMessages = document.getElementById('private-chat-messages');
  const privateChatInput = document.getElementById('private-chat-input');
  const privateChatSend = document.getElementById('private-chat-send');
  const closePrivateChatBtn = document.getElementById('close-private-chat');
  const privateChatTitle = document.getElementById('private-chat-title');
  const shopModal = document.getElementById('shop-modal');
  const shopItems = document.getElementById('shop-items');
  const closeShopBtn = document.getElementById('close-shop');
  const addFriendModal = document.getElementById('add-friend-modal');
  const friendNameInput = document.getElementById('friend-name-input');
  const cancelAddFriendBtn = document.getElementById('cancel-add-friend');
  const confirmAddFriendBtn = document.getElementById('confirm-add-friend');
  const resetScoreBtn = document.getElementById('reset-score-btn');
  const fullscreenBtn = document.getElementById('fullscreen-btn');

  // Sound effects
  const swapSound = document.getElementById('swap-sound');
  const matchSound = document.getElementById('match-sound');
  const selectSound = document.getElementById('select-sound');
  const buttonSound = document.getElementById('button-sound');
  const explosionSound = document.getElementById('explosion-sound');

  // Initialize game when page loads
  window.addEventListener('DOMContentLoaded', () => {
    // Enter fullscreen immediately
    enterFullscreen();
    
    const savedName = localStorage.getItem('puzzleQuestPlayerName');
    const savedGame = localStorage.getItem('puzzleQuestLastGame');
    const savedAvatar = localStorage.getItem('puzzleQuestPlayerAvatar');
    const savedFriends = localStorage.getItem('puzzleQuestFriends');
    const savedThemes = localStorage.getItem('puzzleQuestPurchasedThemes');
    const savedCurrentTheme = localStorage.getItem('puzzleQuestCurrentTheme');
    
    if (savedName) {
      playerName = savedName;
      profileName.textContent = playerName;
      
      if (savedAvatar) {
        playerAvatar.src = savedAvatar;
      }
      
      if (savedFriends) {
        friends = JSON.parse(savedFriends);
      }
      
      if (savedThemes) {
        purchasedThemes = JSON.parse(savedThemes);
      }
      
      if (savedCurrentTheme) {
        currentTheme = savedCurrentTheme;
      }
      
      if (savedGame) {
        try {
          lastGameState = JSON.parse(savedGame);
          score = lastGameState.score;
          updateScoreDisplay();
          
          // Automatically continue last game
          nameModal.style.display = 'none';
          gameContainer.style.display = 'flex';
          initBoardFromSave(lastGameState.grid);
        } catch (e) {
          console.error("Error loading saved game:", e);
          localStorage.removeItem('puzzleQuestLastGame');
          nameModal.style.display = 'none';
          gameContainer.style.display = 'flex';
          initGame();
        }
      } else {
        // No saved game, start fresh
        nameModal.style.display = 'none';
        gameContainer.style.display = 'flex';
        initGame();
      }
    } else {
      // New player
      nameModal.style.display = 'flex';
      nameInput.focus();
    }
    
    // Initialize chat
    initChat();
    
    // Load leaderboard
    loadLeaderboard('global');
    
    // Load friends
    loadFriends();
    
    // Set up presence
    setupPresence();
    
    // Check for unread messages periodically
    setInterval(checkUnreadMessages, 5000);
    
    // Initialize shop items
    initShopItems();
  });

  // Initialize shop items with proper state
  function initShopItems() {
    const shopItems = document.querySelectorAll('.shop-item');
    shopItems.forEach(item => {
      const itemId = item.dataset.item;
      const price = parseInt(item.dataset.price);
      const button = item.querySelector('.shop-item-button');
      
      // Disable button if already purchased (for themes) or not enough points
      if (itemId.includes('theme') && purchasedThemes.includes(itemId.replace('_theme', ''))) {
        button.textContent = 'Purchased';
        button.disabled = true;
      } else if (score < price) {
        button.disabled = true;
      }
      
      // Add click handler
      button.addEventListener('click', () => purchaseItem(itemId, price, button));
    });
  }

  // Handle item purchases
  function purchaseItem(itemId, price, button) {
    if (score < price) {
      alert("Not enough points!");
      return;
    }
    
    buttonSound.currentTime = 0;
    buttonSound.play();
    
    switch(itemId) {
      case 'power_boost':
        powerBoostActive = true;
        updateScore(-price);
        alert("Power Boost activated! Your next matches will give double points!");
        setTimeout(() => {
          powerBoostActive = false;
          alert("Power Boost has expired.");
        }, 60000); // 1 minute
        break;
        
      case 'extra_moves':
        extraMoves += 5;
        updateScore(-price);
        alert("5 extra moves added!");
        break;
        
      case 'minecraft_theme':
      case 'emoji_theme':
      case 'special_theme':
        const theme = itemId.replace('_theme', '');
        if (!purchasedThemes.includes(theme)) {
          purchasedThemes.push(theme);
          localStorage.setItem('puzzleQuestPurchasedThemes', JSON.stringify(purchasedThemes));
          button.textContent = 'Purchased';
          button.disabled = true;
          updateScore(-price);
          alert(`${themes[theme].name} unlocked! You can now select it in the theme menu.`);
        }
        break;
    }
    
    // Update shop items after purchase
    initShopItems();
  }

  // Fullscreen functions
  function enterFullscreen() {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen().catch(err => {
        console.error(`Error attempting to enable fullscreen: ${err.message}`);
      });
      document.body.classList.add('fullscreen');
    }
  }
  
  function toggleFullscreen() {
    buttonSound.currentTime = 0;
    buttonSound.play();
    
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen().catch(err => {
        console.error(`Error attempting to enable fullscreen: ${err.message}`);
      });
    } else {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      }
    }
  }
  
  document.addEventListener('fullscreenchange', () => {
    if (document.fullscreenElement) {
      document.body.classList.add('fullscreen');
    } else {
      document.body.classList.remove('fullscreen');
    }
  });

  // Theme functions
  function changeTheme(theme) {
    if (purchasedThemes.includes(theme)) {
      currentTheme = theme;
      localStorage.setItem('puzzleQuestCurrentTheme', theme);
      
      // Update active theme in modal
      document.querySelectorAll('.theme-item').forEach(item => {
        item.classList.toggle('active', item.dataset.theme === theme);
      });
      
      // Re-render board with new theme
      renderBoard();
      closeThemeBtn.click();
    } else {
      alert("You haven't purchased this theme yet!");
    }
  }

  // Presence system
  function setupPresence() {
    const presenceRef = database.ref('presence/' + playerName);
    
    // Set presence to true when connected
    presenceRef.set(true);
    
    // Remove presence when disconnected
    presenceRef.onDisconnect().remove();
    
    // Monitor connection state
    database.ref('.info/connected').on('value', (snapshot) => {
      if (snapshot.val() === true) {
        presenceRef.set(true);
      }
    });
  }

  // Check for unread messages
  function checkUnreadMessages() {
    const now = Date.now();
    
    // Check global chat
    database.ref('chat').orderByChild('timestamp').startAt(lastChatCheck).once('value', snapshot => {
      const messages = snapshot.val() || {};
      const newMessages = Object.values(messages).filter(msg => 
        msg.sender !== playerName && msg.timestamp > lastChatCheck
      );
      
      if (newMessages.length > 0) {
        unreadChatMessages += newMessages.length;
        updateChatBadge();
        lastChatCheck = now;
      }
    });
    
    // Check private chats
    if (friends.length > 0) {
      friends.forEach(friend => {
        database.ref(`privateChats/${getChatId(friend)}`)
          .orderByChild('timestamp')
          .startAt(lastPrivateChatCheck)
          .once('value', snapshot => {
            const messages = snapshot.val() || {};
            const newMessages = Object.values(messages).filter(msg => 
              msg.sender === friend && msg.timestamp > lastPrivateChatCheck
            );
            
            if (newMessages.length > 0) {
              unreadPrivateMessages += newMessages.length;
              updateFriendsBadge();
              lastPrivateChatCheck = now;
            }
          });
      });
    }
  }
  
  function updateChatBadge() {
    if (unreadChatMessages > 0) {
      chatBadge.textContent = unreadChatMessages;
      chatBadge.style.display = 'flex';
    } else {
      chatBadge.style.display = 'none';
    }
  }
  
  function updateFriendsBadge() {
    if (unreadPrivateMessages > 0) {
      friendsBadge.textContent = unreadPrivateMessages;
      friendsBadge.style.display = 'flex';
    } else {
      friendsBadge.style.display = 'none';
    }
  }

  // Leaderboard tabs
  leaderboardTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      buttonSound.currentTime = 0;
      buttonSound.play();
      
      leaderboardTabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentLeaderboardTab = tab.dataset.tab;
      loadLeaderboard(currentLeaderboardTab);
    });
  });

  function loadLeaderboard(type) {
    if (type === 'global') {
      database.ref('scores').orderByChild('score').limitToLast(50).once('value', snapshot => {
        const data = snapshot.val() || {};
        const scores = Object.entries(data)
          .map(([key, val]) => ({ 
            name: key, 
            score: val.score || 0,
            avatar: val.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(key)}&background=bb86fc&color=121217`,
            badge: getBadgeForScore(val.score || 0)
          }))
          .sort((a, b) => b.score - a.score);
        renderLeaderboard(scores);
      });
    } else {
      // Friends leaderboard
      if (friends.length === 0) {
        renderLeaderboard([]);
        return;
      }
      
      database.ref('scores').once('value', snapshot => {
        const data = snapshot.val() || {};
        const scores = [];
        
        friends.forEach(friend => {
          if (data[friend]) {
            scores.push({
              name: friend,
              score: data[friend].score || 0,
              avatar: data[friend].avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(friend)}&background=bb86fc&color=121217`,
              badge: getBadgeForScore(data[friend].score || 0)
            });
          }
        });
        
        scores.sort((a, b) => b.score - a.score);
        renderLeaderboard(scores);
      });
    }
  }

  function getBadgeForScore(score) {
    if (score >= 1000) return { class: 'diamond', text: 'D' };
    if (score >= 500) return { class: 'platinum', text: 'P' };
    if (score >= 100) return { class: 'gold', text: 'G' };
    if (score >= 50) return { class: 'silver', text: 'S' };
    return { class: 'bronze', text: 'B' };
  }

  function renderLeaderboard(scores) {
    leaderboardScores.innerHTML = '';
    
    if (scores.length === 0) {
      const li = document.createElement('li');
      li.textContent = currentLeaderboardTab === 'global' 
        ? 'No scores recorded yet.' 
        : 'No friends to display. Add some friends first!';
      li.style.fontStyle = 'italic';
      li.style.textAlign = 'center';
      li.style.justifyContent = 'center';
      leaderboardScores.appendChild(li);
      return;
    }
    
    scores.forEach(({name, score, avatar, badge}, index) => {
      const li = document.createElement('li');
      
      const avatarImg = document.createElement('img');
      avatarImg.src = avatar;
      avatarImg.className = 'leaderboard-avatar';
      avatarImg.alt = name;
      
      const nameSpan = document.createElement('span');
      nameSpan.className = 'leaderboard-name';
      nameSpan.textContent = `${index + 1}. ${name}`;
      
      // Add badge to name
      const badgeSpan = document.createElement('span');
      badgeSpan.className = `leaderboard-badge ${badge.class}`;
      badgeSpan.textContent = badge.text;
      nameSpan.appendChild(badgeSpan);
      
      const scoreSpan = document.createElement('span');
      scoreSpan.className = 'leaderboard-score';
      scoreSpan.textContent = score;
      
      li.appendChild(avatarImg);
      li.appendChild(nameSpan);
      li.appendChild(scoreSpan);
      
      leaderboardScores.appendChild(li);
    });
  }

  // Chat functionality
  function initChat() {
    // Load last 50 messages
    database.ref('chat').limitToLast(50).on('value', snapshot => {
      chatMessages.innerHTML = '';
      const messages = snapshot.val() || {};
      
      Object.entries(messages).forEach(([key, msg]) => {
        addChatMessage(msg);
      });
      
      // Scroll to bottom
      setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, 100);
    });
  }
  
  function addChatMessage(msg) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${msg.sender === playerName ? 'own' : 'other'}`;
    
    const senderDiv = document.createElement('div');
    senderDiv.className = 'message-sender';
    
    const avatarImg = document.createElement('img');
    avatarImg.src = msg.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(msg.sender)}&background=bb86fc&color=121217`;
    avatarImg.className = 'message-avatar';
    avatarImg.alt = msg.sender;
    
    senderDiv.appendChild(avatarImg);
    senderDiv.appendChild(document.createTextNode(msg.sender));
    
    const textDiv = document.createElement('div');
    textDiv.className = 'message-text';
    textDiv.textContent = msg.text;
    
    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    timeDiv.textContent = formatTime(msg.timestamp);
    
    messageDiv.appendChild(senderDiv);
    messageDiv.appendChild(textDiv);
    messageDiv.appendChild(timeDiv);
    
    chatMessages.appendChild(messageDiv);
  }
  
  function formatTime(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }
  
  chatSend.addEventListener('click', sendMessage);
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });
  
  function sendMessage() {
    const message = chatInput.value.trim();
    if (message && playerName) {
      const newMessage = {
        sender: playerName,
        text: message,
        avatar: localStorage.getItem('puzzleQuestPlayerAvatar') || `https://ui-avatars.com/api/?name=${encodeURIComponent(playerName)}&background=bb86fc&color=121217`,
        timestamp: Date.now()
      };
      
      database.ref('chat').push(newMessage);
      chatInput.value = '';
    }
  }

  // Private chat functions
  function openPrivateChat(friendName) {
    currentPrivateChatWith = friendName;
    privateChatTitle.textContent = `Chat with ${friendName}`;
    privateChatMessages.innerHTML = '';
    privateChatModal.style.display = 'flex';
    
    // Load private chat messages
    database.ref(`privateChats/${getChatId(friendName)}`).limitToLast(50).on('value', snapshot => {
      privateChatMessages.innerHTML = '';
      const messages = snapshot.val() || {};
      
      Object.entries(messages).forEach(([key, msg]) => {
        addPrivateChatMessage(msg);
      });
      
      // Scroll to bottom
      setTimeout(() => {
        privateChatMessages.scrollTop = privateChatMessages.scrollHeight;
      }, 100);
      
      // Mark messages as read
      unreadPrivateMessages = Math.max(0, unreadPrivateMessages - Object.keys(messages).length);
      updateFriendsBadge();
    });
  }
  
  function addPrivateChatMessage(msg) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${msg.sender === playerName ? 'own' : 'other'}`;
    
    const senderDiv = document.createElement('div');
    senderDiv.className = 'message-sender';
    
    const avatarImg = document.createElement('img');
    avatarImg.src = msg.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(msg.sender)}&background=bb86fc&color=121217`;
    avatarImg.className = 'message-avatar';
    avatarImg.alt = msg.sender;
    
    senderDiv.appendChild(avatarImg);
    senderDiv.appendChild(document.createTextNode(msg.sender));
    
    const textDiv = document.createElement('div');
    textDiv.className = 'message-text';
    textDiv.textContent = msg.text;
    
    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    timeDiv.textContent = formatTime(msg.timestamp);
    
    messageDiv.appendChild(senderDiv);
    messageDiv.appendChild(textDiv);
    messageDiv.appendChild(timeDiv);
    
    privateChatMessages.appendChild(messageDiv);
  }
  
  privateChatSend.addEventListener('click', sendPrivateMessage);
  privateChatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendPrivateMessage();
    }
  });
  
  function sendPrivateMessage() {
    const message = privateChatInput.value.trim();
    if (message && playerName && currentPrivateChatWith) {
      const newMessage = {
        sender: playerName,
        text: message,
        avatar: localStorage.getItem('puzzleQuestPlayerAvatar') || `https://ui-avatars.com/api/?name=${encodeURIComponent(playerName)}&background=bb86fc&color=121217`,
        timestamp: Date.now(),
        recipient: currentPrivateChatWith
      };
      
      database.ref(`privateChats/${getChatId(currentPrivateChatWith)}`).push(newMessage);
      privateChatInput.value = '';
    }
  }
  
  function getChatId(friendName) {
    // Create consistent chat ID regardless of who initiates
    return [playerName, friendName].sort().join('_');
  }

  // Friends functionality
  function loadFriends() {
    if (friends.length === 0) {
      friendsList.innerHTML = '<div style="text-align: center; padding: 20px; color: #aaa;">No friends yet. Add some friends!</div>';
      return;
    }
    
    friendsList.innerHTML = '';
    
    // Get online status for all friends
    database.ref('presence').once('value', snapshot => {
      const onlineUsers = snapshot.val() || {};
      
      friends.forEach(friend => {
        const friendItem = document.createElement('div');
        friendItem.className = 'friend-item';
        friendItem.addEventListener('click', () => {
          buttonSound.currentTime = 0;
          buttonSound.play();
          openPrivateChat(friend);
        });
        
        const friendAvatar = document.createElement('img');
        friendAvatar.className = 'friend-avatar';
        friendAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(friend)}&background=bb86fc&color=121217`;
        
        const friendName = document.createElement('div');
        friendName.className = 'friend-name';
        friendName.textContent = friend;
        
        const friendStatus = document.createElement('div');
        friendStatus.className = `friend-status ${onlineUsers[friend] ? 'online' : ''}`;
        
        friendItem.appendChild(friendAvatar);
        friendItem.appendChild(friendName);
        friendItem.appendChild(friendStatus);
        
        friendsList.appendChild(friendItem);
      });
    });
  }
  
  function addFriend(friendName) {
    if (friendName === playerName) {
      alert("You can't add yourself as a friend!");
      return;
    }
    
    if (friends.includes(friendName)) {
      alert(`${friendName} is already your friend!`);
      return;
    }
    
    // Check if friend exists in database
    database.ref(`scores/${friendName}`).once('value', snapshot => {
      if (snapshot.exists()) {
        friends.push(friendName);
        localStorage.setItem('puzzleQuestFriends', JSON.stringify(friends));
        loadFriends();
        addFriendModal.style.display = 'none';
        friendNameInput.value = '';
      } else {
        alert(`Player "${friendName}" not found. Make sure they've played the game before.`);
      }
    });
  }

  // Menu toggle
  menuBtn.addEventListener('click', (e) => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    playerMenu.style.display = playerMenu.style.display === 'flex' ? 'none' : 'flex';
    e.stopPropagation(); // Prevent document click from closing immediately
  });
  
  // Close menu when clicking outside
  document.addEventListener('click', () => {
    playerMenu.style.display = 'none';
  });

  // Theme selection
  themeBtn.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    playerMenu.style.display = 'none';
    themeModal.style.display = 'flex';
    
    // Update theme items with purchased status
    document.querySelectorAll('.theme-item').forEach(item => {
      const theme = item.dataset.theme;
      item.style.display = purchasedThemes.includes(theme) ? 'flex' : 'none';
    });
  });
  
  // Theme item click handlers
  document.querySelectorAll('.theme-item').forEach(item => {
    item.addEventListener('click', () => {
      if (purchasedThemes.includes(item.dataset.theme)) {
        buttonSound.currentTime = 0;
        buttonSound.play();
        changeTheme(item.dataset.theme);
      }
    });
  });
  
  closeThemeBtn.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    themeModal.style.display = 'none';
  });

  // Rename functionality
  renameBtn.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    playerMenu.style.display = 'none';
    renameInput.value = playerName;
    renameModal.style.display = 'flex';
    renameInput.focus();
  });
  
  renameCancel.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    renameModal.style.display = 'none';
  });
  
  renameConfirm.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    const newName = renameInput.value.trim() || 'Player';
    if (newName.length > 20) {
      playerName = newName.substring(0, 20);
    } else {
      playerName = newName;
    }
    
    // Delete old name from leaderboard if score exists
    if (score > 0) {
      database.ref(`scores/${profileName.textContent}`).remove();
    }
    
    profileName.textContent = playerName;
    localStorage.setItem('puzzleQuestPlayerName', playerName);
    renameModal.style.display = 'none';
    
    // Update Firebase with new name
    if (score > 0) {
      database.ref('scores/' + playerName).set({
        score: score,
        avatar: localStorage.getItem('puzzleQuestPlayerAvatar') || `https://ui-avatars.com/api/?name=${encodeURIComponent(playerName)}&background=bb86fc&color=121217`,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
      });
    }
  });

  // Avatar functionality
  cameraBtn.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    playerMenu.style.display = 'none';
    avatarModalTitle.textContent = 'Take Photo';
    avatarModal.style.display = 'flex';
    startCamera();
  });
  
  galleryBtn.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    playerMenu.style.display = 'none';
    fileInput.click();
  });
  
  fileInput.addEventListener('change', (e) => {
    if (e.target.files && e.target.files[0]) {
      const reader = new FileReader();
      reader.onload = (event) => {
        avatarImagePreview.src = event.target.result;
        avatarImagePreview.style.display = 'block';
        cameraPreview.style.display = 'none';
        avatarModalTitle.textContent = 'Preview Image';
        avatarModal.style.display = 'flex';
        
        // Show upload button
        uploadBtn.style.display = 'block';
        captureBtn.style.display = 'none';
      };
      reader.readAsDataURL(e.target.files[0]);
    }
  });
  
  captureBtn.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    
    const canvas = document.createElement('canvas');
    canvas.width = cameraPreview.videoWidth;
    canvas.height = cameraPreview.videoHeight;
    canvas.getContext('2d').drawImage(cameraPreview, 0, 0);
    
    const imageData = canvas.toDataURL('image/png');
    playerAvatar.src = imageData;
    localStorage.setItem('puzzleQuestPlayerAvatar', imageData);
    
    // Update Firebase with new avatar
    if (score > 0) {
      database.ref('scores/' + playerName).update({
        avatar: imageData,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
      });
    }
    
    stopCamera();
    avatarModal.style.display = 'none';
  });
  
  uploadBtn.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    
    playerAvatar.src = avatarImagePreview.src;
    localStorage.setItem('puzzleQuestPlayerAvatar', avatarImagePreview.src);
    
    // Update Firebase with new avatar
    if (score > 0) {
      database.ref('scores/' + playerName).update({
        avatar: avatarImagePreview.src,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
      });
    }
    
    avatarModal.style.display = 'none';
  });
  
  avatarCancel.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    stopCamera();
    avatarModal.style.display = 'none';
  });
  
  function startCamera() {
    cameraPreview.style.display = 'block';
    avatarImagePreview.style.display = 'none';
    uploadBtn.style.display = 'none';
    captureBtn.style.display = 'block';
    
    navigator.mediaDevices.getUserMedia({ video: true, audio: false })
      .then((mediaStream) => {
        stream = mediaStream;
        cameraPreview.srcObject = stream;
      })
      .catch((err) => {
        console.error("Camera error:", err);
        alert("Could not access camera. Please check permissions.");
        avatarModal.style.display = 'none';
      });
  }
  
  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      cameraPreview.srcObject = null;
      stream = null;
    }
  }

  // Team functionality
  teamBtn.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    playerMenu.style.display = 'none';
    teamModal.style.display = 'flex';
  });
  
  closeTeamBtn.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    teamModal.style.display = 'none';
  });

  // Friends functionality
  friendsBtn.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    playerMenu.style.display = 'none';
    friendsModal.style.display = 'flex';
  });
  
  closeFriendsBtn.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    friendsModal.style.display = 'none';
  });
  
  addFriendBtn.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    friendsModal.style.display = 'none';
    addFriendModal.style.display = 'flex';
    friendNameInput.focus();
  });
  
  cancelAddFriendBtn.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    addFriendModal.style.display = 'none';
    friendsModal.style.display = 'flex';
  });
  
  confirmAddFriendBtn.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    const friendName = friendNameInput.value.trim();
    if (friendName) {
      addFriend(friendName);
    }
  });
  
  friendNameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      buttonSound.currentTime = 0;
      buttonSound.play();
      const friendName = friendNameInput.value.trim();
      if (friendName) {
        addFriend(friendName);
      }
    }
  });

  // Shop functionality
  shopBtn.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    shopModal.style.display = 'flex';
    initShopItems(); // Refresh shop items in case score changed
  });
  
  closeShopBtn.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    shopModal.style.display = 'none';
  });

  // Private chat close
  closePrivateChatBtn.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    privateChatModal.style.display = 'none';
    currentPrivateChatWith = null;
  });

  // Chat modal open/close
  chatBtn.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    chatModal.classList.add('show');
    chatModal.setAttribute('aria-hidden', 'false');
    chatInput.focus();
    
    // Mark messages as read
    unreadChatMessages = 0;
    updateChatBadge();
    lastChatCheck = Date.now();
  });

  closeChatBtn.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    chatModal.classList.remove('show');
    chatModal.setAttribute('aria-hidden', 'true');
  });

  // Reset score functionality
  resetScoreBtn.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    playerMenu.style.display = 'none';
    
    if (confirm("Are you sure you want to reset your score? This cannot be undone!")) {
      score = 0;
      updateScoreDisplay();
      database.ref('scores/' + playerName).remove();
      localStorage.removeItem('puzzleQuestLastGame');
      initShopItems(); // Update shop items since score changed
    }
  });

  function initBoardFromSave(savedGrid) {
    grid = savedGrid;
    renderBoard();
    selectedTile = null;
  }

  function saveGameState() {
    const gameState = {
      score: score,
      grid: grid,
      timestamp: new Date().getTime()
    };
    localStorage.setItem('puzzleQuestLastGame', JSON.stringify(gameState));
    
    // Also update Firebase
    if (score > 0) {
      database.ref('scores/' + playerName).set({
        score: score,
        avatar: localStorage.getItem('puzzleQuestPlayerAvatar') || `https://ui-avatars.com/api/?name=${encodeURIComponent(playerName)}&background=bb86fc&color=121217`,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
      });
    }
  }

  // Name entry handling
  nameSubmit.addEventListener('click', () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    startGame();
  });
  
  nameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      buttonSound.currentTime = 0;
      buttonSound.play();
      startGame();
    }
  });

  function startGame() {
    playerName = nameInput.value.trim() || 'Player';
    if (playerName.length > 20) playerName = playerName.substring(0, 20);
    
    // Save name to localStorage
    localStorage.setItem('puzzleQuestPlayerName', playerName);
    profileName.textContent = playerName;
    
    // Hide name modal and show game
    nameModal.style.display = 'none';
    gameContainer.style.display = 'flex';
    
    // Initialize game
    initGame();
  }

  function initGame() {
    score = 0;
    updateScoreDisplay();
    initBoard();
  }

  function updateScoreDisplay() {
    scoreBoard.textContent = `Score: ${score}`;
    
    // Update score badge
    if (score >= 1000) {
      scoreBadge.className = 'score-badge diamond';
      scoreBadge.textContent = 'üéÜ';
    } else if (score >= 500) {
      scoreBadge.className = 'score-badge platinum';
      scoreBadge.textContent = 'üßø';
    } else if (score >= 100) {
      scoreBadge.className = 'score-badge gold';
      scoreBadge.textContent = 'üåü';
    } else if (score >= 50) {
      scoreBadge.className = 'score-badge silver';
      scoreBadge.textContent = 'üóø';
    } else {
      scoreBadge.className = 'score-badge bronze';
      scoreBadge.textContent = 'üêö';
    }
  }

  // Tile creation
  function createTile(r, c, colorIdx) {
    const div = document.createElement('div');
    div.className = `tile color-${colorIdx}`;
    div.dataset.row = r;
    div.dataset.col = c;
    div.dataset.color = colorIdx;
    div.setAttribute('role', 'button');
    div.setAttribute('tabindex', '0');
    div.setAttribute('aria-label', `Tile ${themes[currentTheme].emojis[colorIdx]}`);
    div.textContent = themes[currentTheme].emojis[colorIdx];
    div.style.borderColor = themes[currentTheme].colors[colorIdx];
    div.addEventListener('click', onTileClick);
    div.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        div.click();
      }
    });
    return div;
  }

  // Board initialization
  function initBoard() {
    grid = [];
    for (let r = 0; r < ROWS; r++) {
      const row = [];
      for (let c = 0; c < COLS; c++) {
        let color;
        do {
          color = Math.floor(Math.random() * COLORS_COUNT);
        } while (
          (c >= 2 && color === row[c - 1] && color === row[c - 2]) ||
          (r >= 2 && color === grid[r - 1][c] && color === grid[r - 2][c])
        );
        row.push(color);
      }
      grid.push(row);
    }
    renderBoard();
    selectedTile = null;
  }

  function renderBoard() {
    board.innerHTML = '';
    for (let r = 0; r < ROWS; r++) {
      for (let c = 0; c < COLS; c++) {
        board.appendChild(createTile(r, c, grid[r][c]));
      }
    }
  }

  // Score update
  function updateScore(points) {
    if (powerBoostActive) {
      points *= 2; // Double points when power boost is active
    }
    
    score += points;
    if (score < 0) score = 0;
    
    updateScoreDisplay();
    saveGameState();
    initShopItems(); // Update shop items since score changed
  }

  // Helper functions
  function isAdjacent(r1, c1, r2, c2) {
    return (r1 === r2 && Math.abs(c1 - c2) === 1) || (c1 === c2 && Math.abs(r1 - r2) === 1);
  }

  function swapTiles(r1, c1, r2, c2) {
    // No point deduction, swaps are always free
    swapSound.currentTime = 0;
    swapSound.play();
    
    const temp = grid[r1][c1];
    grid[r1][c1] = grid[r2][c2];
    grid[r2][c2] = temp;

    const t1 = board.querySelector(`.tile[data-row="${r1}"][data-col="${c1}"]`);
    const t2 = board.querySelector(`.tile[data-row="${r2}"][data-col="${c2}"]`);

    t1.dataset.color = grid[r1][c1];
    t2.dataset.color = grid[r2][c2];

    t1.textContent = themes[currentTheme].emojis[grid[r1][c1]];
    t2.textContent = themes[currentTheme].emojis[grid[r2][c2]];
    
    t1.style.borderColor = themes[currentTheme].colors[grid[r1][c1]];
    t2.style.borderColor = themes[currentTheme].colors[grid[r2][c2]];
    
    return true;
}

  // Match finding
  function findMatches() {
    const matches = [];
    // horizontal matches
    for (let r = 0; r < ROWS; r++) {
      let count = 1;
      for (let c = 1; c < COLS; c++) {
        if (grid[r][c] === grid[r][c - 1]) count++;
        else {
          if (count >= 3) {
            for (let k = 0; k < count; k++) matches.push({ r: r, c: c - 1 - k });
          }
          count = 1;
        }
      }
      if (count >= 3) {
        for (let k = 0; k < count; k++) matches.push({ r: r, c: COLS - 1 - k });
      }
    }
    // vertical matches
    for (let c = 0; c < COLS; c++) {
      let count = 1;
      for (let r = 1; r < ROWS; r++) {
        if (grid[r][c] === grid[r - 1][c]) count++;
        else {
          if (count >= 3) {
            for (let k = 0; k < count; k++) matches.push({ r: r - 1 - k, c: c });
          }
          count = 1;
        }
      }
      if (count >= 3) {
        for (let k = 0; k < count; k++) matches.push({ r: ROWS - 1 - k, c: c });
      }
    }
    // Remove duplicates
    const unique = [];
    const seen = new Set();
    matches.forEach(({ r, c }) => {
      const key = r + ',' + c;
      if (!seen.has(key)) {
        seen.add(key);
        unique.push({ r, c });
      }
    });
    return unique;
  }

  // Remove matches and collapse
  function removeMatchesAndCollapse(matches) {
    if (matches.length === 0) return false;
    
    // Play match sound
    matchSound.currentTime = 0;
    matchSound.play();
    
    // Add explosion effects and mark tiles as matched
    matches.forEach(({ r, c }) => {
      const tile = board.querySelector(`.tile[data-row="${r}"][data-col="${c}"]`);
      if (tile) {
        tile.classList.add('matched');
        
        // Add explosion effect
        const explosion = document.createElement('div');
        explosion.className = 'explosion';
        tile.appendChild(explosion);
        
        // Play explosion sound for each match
        setTimeout(() => {
          explosionSound.currentTime = 0;
          explosionSound.play();
        }, 100);
      }
    });
    
    // Update score after animation starts
    setTimeout(() => {
      matches.forEach(({ r, c }) => (grid[r][c] = null));
      updateScore(matches.length * 10);

      // Collapse and refill after animation completes
      setTimeout(() => {
        for (let c = 0; c < COLS; c++) {
          let newCol = [];
          for (let r = ROWS - 1; r >= 0; r--) if (grid[r][c] !== null) newCol.push(grid[r][c]);
          while (newCol.length < ROWS) newCol.push(Math.floor(Math.random() * COLORS_COUNT));
          for (let r = ROWS - 1, i = 0; r >= 0; r--, i++) grid[r][c] = newCol[i];
        }
        renderBoard();
      }, 300);
    }, 100);
    
    return true;
  }

  // Tile click handler
  function onTileClick(e) {
    const tile = e.currentTarget;
    const r = parseInt(tile.dataset.row);
    const c = parseInt(tile.dataset.col);
    
    if (selectedTile === null) {
      selectSound.currentTime = 0;
      selectSound.play();
      selectTile(r, c, tile);
    } else {
      if (r === selectedTile.r && c === selectedTile.c) {
        deselectTile();
      } else if (isAdjacent(r, c, selectedTile.r, selectedTile.c)) {
        swapTiles(r, c, selectedTile.r, selectedTile.c);
if (findMatches().length === 0) {
    setTimeout(() => {
        swapTiles(r, c, selectedTile.r, selectedTile.c); // Swap back if no match
        deselectTile();
    }, 300);
} else {
    deselectTile();
    chainRemove();
}
      } else {
        deselectTile();
        selectSound.currentTime = 0;
        selectSound.play();
        selectTile(r, c, tile);
      }
    }
  }

  function selectTile(r, c, tile) {
    selectedTile = { r, c, element: tile };
    tile.classList.add('selected');
  }

  function deselectTile() {
    if (selectedTile) {
      selectedTile.element.classList.remove('selected');
      selectedTile = null;
    }
  }

  function chainRemove() {
    const matches = findMatches();
    if (matches.length === 0) return;
    removeMatchesAndCollapse(matches);
    setTimeout(chainRemove, 800); // Longer delay to allow animations to complete
  }

  // Event listeners
  resetBtn.onclick = () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    deselectTile();
    score = 0;
    powerBoostActive = false;
    extraMoves = 0;
    updateScoreDisplay();
    localStorage.removeItem('puzzleQuestLastGame');
    initBoard();
    initShopItems();
  };

  leaderboardBtn.onclick = () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    leaderboardModal.classList.add('show');
    leaderboardModal.setAttribute('aria-hidden', 'false');
    leaderboardModal.focus();
  };

  closeLeaderboardBtn.onclick = () => {
    buttonSound.currentTime = 0;
    buttonSound.play();
    leaderboardModal.classList.remove('show');
    leaderboardModal.setAttribute('aria-hidden', 'true');
  };

  // Save game when leaving the page
  window.addEventListener('beforeunload', () => {
    if (score > 0) {
      saveGameState();
    }
  });
})();
</script>
</body>
</html>

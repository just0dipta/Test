<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Puzzle Quest</title>
<style>
  /* Reset */
  * { box-sizing: border-box; }
  html, body {
    margin: 0; padding: 0; height: 100%; overflow: hidden;
    background: #121217;
    color: #eee;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  body {
    display: flex; align-items: center; justify-content: center;
    -webkit-tap-highlight-color: transparent;
  }
  #game-container {
    background: #1e1e2f;
    border-radius: 16px;
    box-shadow: 0 0 15px 2px #440099aa, 0 10px 25px rgba(0,0,0,0.9);
    width: 340px;
    height: 600px;
    display: flex;
    flex-direction: column;
    padding: 16px;
    box-sizing: border-box;
    position: relative;
  }
  header { text-align: center; margin-bottom: 8px; user-select: none; }
  header h1 {
    font-size: 1.8rem;
    letter-spacing: 2.5px;
    margin: 0 0 2px;
    color: #bb86fc;
    text-shadow: 0 0 8px #bb86fc99;
  }
  header p {
    margin: 0;
    font-size: 0.85rem;
    color: #aaaabbcc;
  }
  #player-name {
    position: absolute;
    top: 14px;
    left: 14px;
    font-weight: 700;
    color: #bb86fccc;
    font-size: 0.9rem;
    user-select: none;
  }
  #score-board {
    margin: 4px 0 8px;
    font-weight: 700;
    font-size: 1.1rem;
    text-align: center;
    color: #ffb86c;
    text-shadow: 0 0 4px #ffb86c99;
    user-select: none;
    line-height: 1.4;
  }
  #score-board span {
    font-size: 0.9rem;
    color: #bb86fc;
  }
  #board {
    flex-grow: 1;
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    grid-gap: 4px;
    background: #2a2a44;
    border-radius: 14px;
    padding: 6px;
    box-shadow: inset 0 0 12px #111133cc;
    user-select: none;
  }
  .tile {
    background: #3b3d5c;
    border-radius: 10px;
    width: 44px;
    height: 44px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.7rem;
    user-select: none;
    border: 3px solid transparent;
    transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.3s ease;
    box-shadow: inset 0 1px 3px #666777aa;
  }
  .tile.selected {
    outline: 3px solid #fff;
    box-shadow: 0 0 16px 4px #ffffffcc;
    transform: scale(1.1);
    z-index: 10;
  }
  .tile.color-0 { border-color: #ff4c4c;}
  .tile.color-1 { border-color: #f7a932;}
  .tile.color-2 { border-color: #3bb3ff;}
  .tile.color-3 { border-color: #40da47;}
  .tile.color-4 { border-color: #ffd947;}
  .tile.color-5 { border-color: #ac41ff;}
  #controls {
    margin-top: 8px;
    display: flex;
    justify-content: space-between;
  }
  button {
    background: #bb86fc;
    color: #121217;
    border: none;
    border-radius: 14px;
    padding: 10px 18px;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 6px 14px #bb86fcaa;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    user-select: none;
  }
  button:hover,
  button:focus {
    background: #9a6fff;
    box-shadow: 0 8px 18px #9a6fffcc;
    outline: none;
  }
  #instructions {
    font-size: 0.75rem;
    color: #999aadcc;
    margin-top: 6px;
    text-align: center;
    user-select: none;
    line-height: 1.3;
  }
  #leaderboard-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    width: 320px;
    max-height: 80vh;
    background: #1e1e2f;
    border-radius: 16px;
    box-shadow: 0 0 20px #bb86fccc;
    color: #eee;
    z-index: 2000;
    transition: transform 0.3s ease;
    user-select: none;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  #leaderboard-modal.show {
    transform: translate(-50%, -50%) scale(1);
  }
  #leaderboard-header {
    background: #3b3d5c;
    padding: 14px;
    font-weight: 700;
    font-size: 1.3rem;
    text-align: center;
    border-top-left-radius: 16px;
    border-top-right-radius: 16px;
    user-select: none;
  }
  #leaderboard-list {
    flex-grow: 1;
    overflow-y: auto;
    padding: 8px 16px;
  }
  #leaderboard-list ul {
    list-style: none;
    margin: 0;
    padding: 0;
  }
  #leaderboard-list li {
    padding: 8px 4px;
    border-bottom: 1px solid #555577;
    font-size: 1.1rem;
    display: flex;
    justify-content: space-between;
    font-weight: 600;
  }
  #leaderboard-list li:last-child {
    border-bottom: none;
  }
  #leaderboard-footer {
    background: #3b3d5c;
    padding: 10px 14px;
    display: flex;
    justify-content: flex-end;
    border-bottom-left-radius: 16px;
    border-bottom-right-radius: 16px;
  }
  #close-leaderboard {
    background: #bb86fc;
    border: none;
    border-radius: 12px;
    padding: 8px 16px;
    font-weight: 700;
    cursor: pointer;
    color: #121217;
    box-shadow: 0 4px 10px #bb86fcaa;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    user-select: none;
  }
  #close-leaderboard:hover,
  #close-leaderboard:focus {
    background: #9a6fff;
    box-shadow: 0 6px 14px #9a6fffcc;
    outline: none;
  }
  .celebrate {
    animation: pulse 0.5s ease 3;
  }
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }
  #name-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 3000;
  }
  #name-form {
    background: #1e1e2f;
    padding: 24px;
    border-radius: 16px;
    width: 300px;
    text-align: center;
  }
  #name-form h2 {
    margin-top: 0;
    color: #bb86fc;
  }
  #name-input {
    width: 100%;
    padding: 12px;
    margin: 16px 0;
    border: 2px solid #bb86fc;
    border-radius: 8px;
    background: #2a2a44;
    color: white;
    font-size: 1rem;
  }
  #name-submit {
    background: #bb86fc;
    color: #121217;
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  #name-submit:hover {
    background: #9a6fff;
  }
  @media (max-width: 400px) {
    #game-container {
      width: 320px;
      height: 580px;
      padding: 12px;
    }
    header h1 {
      font-size: 1.6rem;
    }
    #score-board {
      font-size: 1rem;
    }
    button {
      font-size: 0.9rem;
      padding: 8px 16px;
    }
    #instructions {
      font-size: 0.7rem;
    }
    .tile {
      width: 40px;
      height: 40px;
      font-size: 1.5rem;
    }
    #leaderboard-modal {
      width: 90vw;
    }
    #name-form {
      width: 90vw;
    }
  }
</style>
<!-- Firebase scripts -->
<script src="https://www.gstatic.com/firebasejs/9.18.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.18.0/firebase-database-compat.js"></script>
</head>
<body>
<div id="name-modal">
  <div id="name-form">
    <h2>Enter Your Name</h2>
    <input type="text" id="name-input" placeholder="Player name" maxlength="20" autofocus>
    <button id="name-submit">Start Game</button>
  </div>
</div>

<div id="game-container" aria-label="Puzzle Quest game" style="display: none;">
  <div id="player-name" aria-live="polite" aria-atomic="true"></div>
  <header>
    <h1>Puzzle Quest</h1>
    <p>Match 3 or more tiles by swapping adjacent ones!</p>
  </header>
  <div id="score-board">Score: 0<br><span>High Score: 0</span></div>
  <div id="board" aria-label="Game board, 6 by 6 grid" tabindex="0"></div>
  <div id="controls">
    <button id="reset-btn" aria-label="Reset game">Reset Game</button>
    <button id="leaderboard-btn" aria-label="Show Leaderboard">Leaderboard</button>
  </div>
  <div id="instructions">
    Tap or click a tile to select it, then tap an adjacent tile to swap.<br />
    Match 3 or more tiles of the same fruit horizontally or vertically to score points.
  </div>
</div>

<!-- Leaderboard Modal -->
<div id="leaderboard-modal" role="dialog" aria-modal="true" aria-labelledby="leaderboard-header" tabindex="-1" aria-hidden="true">
  <div id="leaderboard-header">Leaderboard</div>
  <div id="leaderboard-list" tabindex="0">
    <ul id="leaderboard-scores"></ul>
  </div>
  <div id="leaderboard-footer">
    <button id="close-leaderboard">Close</button>
  </div>
</div>

<script>
(() => {
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDexnxE8BAytVuwp8QlqTGdqp-T8TvT-JI",
    authDomain: "puzzlequestgame-2b885.firebaseapp.com",
    databaseURL: "https://puzzlequestgame-2b885-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "puzzlequestgame-2b885",
    storageBucket: "puzzlequestgame-2b885.firebasestorage.app",
    messagingSenderId: "853619803651",
    appId: "1:853619803651:web:1d5be33744a40562ad7036"
  };
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  // Game constants
  const ROWS = 6;
  const COLS = 6;
  const COLORS_COUNT = 6;
  const fruitEmojis = ['ðŸŽ', 'ðŸŠ', 'ðŸ¥­', 'ðŸ“', 'ðŸŒ', 'ðŸ‘'];

  // Game state
  let grid = [];
  let selectedTile = null;
  let score = 0;
  let highScore = 0;
  let playerName = 'Player';

  // DOM elements
  const nameModal = document.getElementById('name-modal');
  const nameInput = document.getElementById('name-input');
  const nameSubmit = document.getElementById('name-submit');
  const gameContainer = document.getElementById('game-container');
  const playerNameDisplay = document.getElementById('player-name');
  const scoreBoard = document.getElementById('score-board');
  const board = document.getElementById('board');
  const resetBtn = document.getElementById('reset-btn');
  const leaderboardBtn = document.getElementById('leaderboard-btn');
  const leaderboardModal = document.getElementById('leaderboard-modal');
  const leaderboardScores = document.getElementById('leaderboard-scores');
  const closeLeaderboardBtn = document.getElementById('close-leaderboard');

  // Initialize game when page loads
  window.addEventListener('DOMContentLoaded', () => {
    const savedName = localStorage.getItem('puzzleQuestPlayerName');
    if (savedName) {
      // If we have a saved name, skip the name modal
      playerName = savedName;
      playerNameDisplay.textContent = `Player: ${playerName}`;
      nameModal.style.display = 'none';
      gameContainer.style.display = 'flex';
      initGame();
    } else {
      // Show name modal if no name is saved
      nameModal.style.display = 'flex';
      nameInput.focus();
    }
  });

  // Name entry handling
  nameSubmit.addEventListener('click', startGame);
  nameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') startGame();
  });

  function startGame() {
    playerName = nameInput.value.trim() || 'Player';
    if (playerName.length > 20) playerName = playerName.substring(0, 20);
    
    // Save name to localStorage
    localStorage.setItem('puzzleQuestPlayerName', playerName);
    playerNameDisplay.textContent = `Player: ${playerName}`;
    
    // Hide name modal and show game
    nameModal.style.display = 'none';
    gameContainer.style.display = 'flex';
    
    // Initialize game
    initGame();
  }

  // Score storage functions
  function getStoredHighScore() {
    return parseInt(localStorage.getItem('puzzleQuestHighScore')) || 0;
  }

  function updateStoredHighScore(newScore) {
    localStorage.setItem('puzzleQuestHighScore', newScore.toString());
  }

  function getLocalScores() {
    const saved = localStorage.getItem('puzzleQuestLocalScores');
    return saved ? JSON.parse(saved) : [];
  }

  function updateLocalScores(newScore) {
    const scores = getLocalScores();
    scores.unshift({
      score: newScore,
      date: new Date().toISOString()
    });
    // Keep only last 10 scores
    const updatedScores = scores.slice(0, 10);
    localStorage.setItem('puzzleQuestLocalScores', JSON.stringify(updatedScores));
    return updatedScores;
  }

  function initGame() {
    highScore = getStoredHighScore();
    updateScoreDisplay();
    initBoard();
  }

  function updateScoreDisplay() {
    scoreBoard.innerHTML = `Score: ${score}<br><span>High Score: ${highScore}</span>`;
  }

  // Tile creation
  function createTile(r, c, colorIdx) {
    const div = document.createElement('div');
    div.className = `tile color-${colorIdx}`;
    div.dataset.row = r;
    div.dataset.col = c;
    div.dataset.color = colorIdx;
    div.setAttribute('role', 'button');
    div.setAttribute('tabindex', '0');
    div.setAttribute('aria-label', `Fruit tile ${fruitEmojis[colorIdx]}`);
    div.textContent = fruitEmojis[colorIdx];
    div.addEventListener('click', onTileClick);
    div.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        div.click();
      }
    });
    return div;
  }

  // Board initialization
  function initBoard() {
    grid = [];
    for (let r = 0; r < ROWS; r++) {
      const row = [];
      for (let c = 0; c < COLS; c++) {
        let color;
        do {
          color = Math.floor(Math.random() * COLORS_COUNT);
        } while (
          (c >= 2 && color === row[c - 1] && color === row[c - 2]) ||
          (r >= 2 && color === grid[r - 1][c] && color === grid[r - 2][c])
        );
        row.push(color);
      }
      grid.push(row);
    }
    renderBoard();
    score = 0;
    updateScoreDisplay();
    selectedTile = null;
  }

  function renderBoard() {
    board.innerHTML = '';
    for (let r = 0; r < ROWS; r++) {
      for (let c = 0; c < COLS; c++) {
        board.appendChild(createTile(r, c, grid[r][c]));
      }
    }
  }

  // Score update
  function updateScore(points) {
    score += points;
    if (score < 0) score = 0;
    
    const beatHighScore = score > highScore;
    if (beatHighScore) {
      highScore = score;
      updateStoredHighScore(highScore);
      scoreBoard.classList.add('celebrate');
      setTimeout(() => scoreBoard.classList.remove('celebrate'), 1500);
    }
    
    updateScoreDisplay();
    
    // Update Firebase
    database.ref('scores/' + playerName).set({
      score: score,
      updatedAt: firebase.database.ServerValue.TIMESTAMP
    });
    
    // Update local scores
    updateLocalScores(score);
  }

  // Helper functions
  function isAdjacent(r1, c1, r2, c2) {
    return (r1 === r2 && Math.abs(c1 - c2) === 1) || (c1 === c2 && Math.abs(r1 - r2) === 1);
  }

  function swapTiles(r1, c1, r2, c2) {
    const temp = grid[r1][c1];
    grid[r1][c1] = grid[r2][c2];
    grid[r2][c2] = temp;

    const t1 = board.querySelector(`.tile[data-row="${r1}"][data-col="${c1}"]`);
    const t2 = board.querySelector(`.tile[data-row="${r2}"][data-col="${c2}"]`);

    t1.dataset.color = grid[r1][c1];
    t2.dataset.color = grid[r2][c2];

    t1.textContent = fruitEmojis[grid[r1][c1]];
    t2.textContent = fruitEmojis[grid[r2][c2]];
  }

  // Match finding
  function findMatches() {
    const matches = [];
    // horizontal matches
    for (let r = 0; r < ROWS; r++) {
      let count = 1;
      for (let c = 1; c < COLS; c++) {
        if (grid[r][c] === grid[r][c - 1]) count++;
        else {
          if (count >= 3) {
            for (let k = 0; k < count; k++) matches.push({ r: r, c: c - 1 - k });
          }
          count = 1;
        }
      }
      if (count >= 3) {
        for (let k = 0; k < count; k++) matches.push({ r: r, c: COLS - 1 - k });
      }
    }
    // vertical matches
    for (let c = 0; c < COLS; c++) {
      let count = 1;
      for (let r = 1; r < ROWS; r++) {
        if (grid[r][c] === grid[r - 1][c]) count++;
        else {
          if (count >= 3) {
            for (let k = 0; k < count; k++) matches.push({ r: r - 1 - k, c: c });
          }
          count = 1;
        }
      }
      if (count >= 3) {
        for (let k = 0; k < count; k++) matches.push({ r: ROWS - 1 - k, c: c });
      }
    }
    // Remove duplicates
    const unique = [];
    const seen = new Set();
    matches.forEach(({ r, c }) => {
      const key = r + ',' + c;
      if (!seen.has(key)) {
        seen.add(key);
        unique.push({ r, c });
      }
    });
    return unique;
  }

  // Remove matches and collapse
  function removeMatchesAndCollapse(matches) {
    if (matches.length === 0) return false;
    matches.forEach(({ r, c }) => (grid[r][c] = null));
    updateScore(matches.length * 10);

    for (let c = 0; c < COLS; c++) {
      let newCol = [];
      for (let r = ROWS - 1; r >= 0; r--) if (grid[r][c] !== null) newCol.push(grid[r][c]);
      while (newCol.length < ROWS) newCol.push(Math.floor(Math.random() * COLORS_COUNT));
      for (let r = ROWS - 1, i = 0; r >= 0; r--, i++) grid[r][c] = newCol[i];
    }
    renderBoard();
    return true;
  }

  // Tile click handler
  function onTileClick(e) {
    const tile = e.currentTarget;
    const r = parseInt(tile.dataset.row);
    const c = parseInt(tile.dataset.col);
    if (selectedTile === null) selectTile(r, c, tile);
    else {
      if (r === selectedTile.r && c === selectedTile.c) deselectTile();
      else if (isAdjacent(r, c, selectedTile.r, selectedTile.c)) {
        swapTiles(r, c, selectedTile.r, selectedTile.c);
        if (findMatches().length === 0) {
          setTimeout(() => {
            swapTiles(r, c, selectedTile.r, selectedTile.c);
            deselectTile();
          }, 300);
        } else {
          deselectTile();
          chainRemove();
        }
      } else {
        deselectTile();
        selectTile(r, c, tile);
      }
    }
  }

  function selectTile(r, c, tile) {
    selectedTile = { r, c, element: tile };
    tile.classList.add('selected');
  }

  function deselectTile() {
    if (selectedTile) {
      selectedTile.element.classList.remove('selected');
      selectedTile = null;
    }
  }

  function chainRemove() {
    const matches = findMatches();
    if (matches.length === 0) return;
    removeMatchesAndCollapse(matches);
    setTimeout(chainRemove, 350);
  }

  // Event listeners
  resetBtn.onclick = () => {
    deselectTile();
    score = 0;
    updateScoreDisplay();
    initBoard();
  };

  leaderboardBtn.onclick = () => {
    // Show both global and local scores
    database.ref('scores').orderByChild('score').limitToLast(10).once('value', snapshot => {
      const globalData = snapshot.val() || {};
      const globalScores = Object.entries(globalData)
        .map(([key, val]) => ({ name: key, score: val.score || 0 }))
        .sort((a, b) => b.score - a.score);
      
      const localScores = getLocalScores().map(entry => ({
        name: playerName,
        score: entry.score,
        date: new Date(entry.date).toLocaleDateString()
      }));
      
      renderLeaderboard(globalScores, localScores);
      leaderboardModal.classList.add('show');
      leaderboardModal.setAttribute('aria-hidden', 'false');
      leaderboardModal.focus();
    });
  };

  closeLeaderboardBtn.onclick = () => {
    leaderboardModal.classList.remove('show');
    leaderboardModal.setAttribute('aria-hidden', 'true');
  };

  function renderLeaderboard(globalScores, localScores) {
    leaderboardScores.innerHTML = '';
    
    // Add global leaderboard section
    const globalHeader = document.createElement('li');
    globalHeader.innerHTML = '<strong style="width:100%; text-align:center; display:block; margin: 8px 0;">Global Leaderboard</strong>';
    leaderboardScores.appendChild(globalHeader);
    
    if (globalScores.length === 0) {
      const li = document.createElement('li');
      li.textContent = 'No global scores yet';
      li.style.fontStyle = 'italic';
      li.style.textAlign = 'center';
      leaderboardScores.appendChild(li);
    } else {
      globalScores.forEach(({name, score}, index) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <div>${index + 1}. ${name}</div>
          <div>${score}</div>
        `;
        leaderboardScores.appendChild(li);
      });
    }
    
    // Add separator
    const separator = document.createElement('li');
    separator.style.height = '1px';
    separator.style.backgroundColor = '#555577';
    separator.style.margin = '8px 0';
    leaderboardScores.appendChild(separator);
    
    // Add personal scores section
    const personalHeader = document.createElement('li');
    personalHeader.innerHTML = '<strong style="width:100%; text-align:center; display:block; margin: 8px 0;">Your Recent Scores</strong>';
    leaderboardScores.appendChild(personalHeader);
    
    if (localScores.length === 0) {
      const li = document.createElement('li');
      li.textContent = 'No personal scores yet';
      li.style.fontStyle = 'italic';
      li.style.textAlign = 'center';
      leaderboardScores.appendChild(li);
    } else {
      localScores.forEach(({name, score, date}, index) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <div>${index + 1}. ${score}</div>
          <small style="font-size: 0.7rem; opacity: 0.7;">${date}</small>
        `;
        leaderboardScores.appendChild(li);
      });
    }
  }
})();
</script>
</body>
</html>
